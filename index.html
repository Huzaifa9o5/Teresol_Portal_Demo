<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TERE-HCM Dashboard</title>
    <link rel="stylesheet" href="css/style.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
  </head>

  <body>
    <!-- ===== Top Navigation ===== -->
    <nav class="topnav">
      <div class="logo">TERE-HCM</div>
      <ul class="nav-links">
        <li>
          <a href="#"
            ><img src="assets/icons/dashboard.png" alt="" />Dashboard</a
          >
        </li>
        <li>
          <a href="#"
            ><img src="assets/icons/organization.png" alt="" />Organization</a
          >
        </li>
        <li>
          <a href="../pages/employee.html"
            ><img src="assets/icons/employee.png" alt="" />Employee</a
          >
        </li>
        <li>
          <a href="attendance-leave.html">
            <img
              src="assets/icons/attendance-leave.png"
              alt=""
            />Attendance/Leave
          </a>
        </li>
        <li>
          <a href="#"><img src="assets/icons/reports.png" alt="" />Reports</a>
        </li>
      </ul>
    </nav>

    <!-- ===== Main Dashboard Layout ===== -->
    <div class="dashboard">
      <!-- Left Profile Section -->
      <aside class="profile-section">
        <div class="ess-header">ESS Dashboard</div>
        <div class="profile-card">
          <div class="avatar"></div>
          <h3>Anna Caxilijan</h3>
          <p>Archietecture Engineer</p>
        </div>

        <section class="summary-card">
          <h3>Attendance Summary</h3>
          <table>
            <tbody>
              <tr>
                <td>Present</td>
                <td>14</td>
              </tr>
              <tr>
                <td>Absent</td>
                <td>00</td>
              </tr>
              <tr>
                <td>Half Day</td>
                <td>00</td>
              </tr>
              <tr>
                <td>Off Day</td>
                <td>00</td>
              </tr>
              <tr>
                <td>Missing</td>
                <td>15</td>
              </tr>
              <tr>
                <td>Leave</td>
                <td>00</td>
              </tr>
            </tbody>
          </table>
        </section>
      </aside>

      <!-- Right Content -->
      <main class="main-content">
        <!-- Attendance Summary Chart -->
        <section id="attendance-summary" class="summary-card">
          <h3>Monthly Attendance Performance (30 Days)</h3>
          <p id="avg-time-display">
            Average daily time: <strong id="avg-time-value">Loading...</strong>
          </p>
          <canvas id="attendanceChart" height="300"></canvas>
          <div
            id="legend-info"
            style="margin-top: 15px; font-size: 0.9em; text-align: center"
          >
            <span style="color: #2aa54f">■ $\ge 8$ Hours (Green)</span>
            <span style="color: #ffc107; margin-left: 15px"
              >■ $0 <$ Hours $< 8$ (Yellow)</span
            >
            <span style="color: #d83b13; margin-left: 15px"
              >■ Absent/0 Hours (Red)</span
            >
            <span style="color: #007bff; margin-left: 15px"
              >■ Leave/Rest Day (Blue)</span
            >
          </div>
        </section>

        <div class="grid-2">
          <!-- Leave Summary -->
          <section id="leave-summary" class="summary-card">
            <h3>Leave Summary</h3>
            <table>
              <tbody>
                <tr>
                  <td>Casual Leave</td>
                  <td>08</td>
                </tr>
                <tr>
                  <td>Maternity Leave</td>
                  <td>90</td>
                </tr>
                <tr>
                  <td>Sick Leave</td>
                  <td>08</td>
                </tr>
                <tr>
                  <td>Marriage Leave</td>
                  <td>15</td>
                </tr>
                <tr>
                  <td>Annual Leave</td>
                  <td>15</td>
                </tr>
                <tr>
                  <td>Hajj Leave</td>
                  <td>30</td>
                </tr>
              </tbody>
            </table>
          </section>

          <div id="attendance-details" class="attendance-details">
            <h4>Attendance Details</h4>
            <table>
              <thead>
                <tr>
                  <th>Sr</th>
                  <th>Date</th>
                  <th>Type</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>1</td>
                  <td>09Sep25</td>
                  <td>Missing</td>
                  <td>Accept</td>
                </tr>
                <tr>
                  <td>2</td>
                  <td>01Sep25</td>
                  <td>Absent</td>
                  <td>Reject</td>
                </tr>
                <tr>
                  <td>3</td>
                  <td>03Sep25</td>
                  <td>Absent</td>
                  <td>Reject</td>
                </tr>
                <tr>
                  <td>4</td>
                  <td>04Sep25</td>
                  <td>Absent</td>
                  <td>Reject</td>
                </tr>
                <tr>
                  <td>5</td>
                  <td>05Sep25</td>
                  <td>Absent</td>
                  <td>Reject</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- ===== Updated Tiles Section ===== -->
        <div class="grid-2">
          <!-- News/Policy Combined -->
          <section id="news-policy" class="tab-card">
            <div class="tabs">
              <button class="tab-btn active" data-tab="news-left">News</button>
              <button class="tab-btn" data-tab="policy-left">Policy</button>
            </div>
            <div class="tab-content active" id="news-left">
              <ul>
                <li>Saad Afzal Work Anniversary Today</li>
                <li>Huzaifa Ahmed Birthday Today</li>
                <li>
                  Company will stay close on 09th Oct for Iqbal Day’s
                  Celebration
                </li>
              </ul>
            </div>
            <div class="tab-content" id="policy-left">
              <ul>
                <li>
                  Wedding Leave Policy
                  <a href="#"><i class="fa-solid fa-download"></i></a>
                </li>
                <li>
                  Increment / Promotion Policy
                  <a href="#"><i class="fa-solid fa-download"></i></a>
                </li>
                <li>
                  IPD Reimbursement Policy
                  <a href="#"><i class="fa-solid fa-download"></i></a>
                </li>
              </ul>
            </div>
          </section>

          <!-- My Team / My Manager -->
          <section id="team-manager" class="tab-card">
            <div class="tabs">
              <button class="tab-btn active" data-tab="team">My Team</button>
              <button class="tab-btn" data-tab="manager">My Manager</button>
            </div>
            <div class="tab-content active" id="team">
              <ul>
                <li>Saad Afzal</li>
                <li>Hassan Bin Tahir</li>
                <li>Sufyan Sikandar</li>
              </ul>
            </div>
            <div class="tab-content" id="manager">
              <p>Adeel Tariq</p>
            </div>
          </section>
        </div>
      </main>
    </div>

    <!-- JS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="js/script.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        initAttendanceChart();
      });

      const timeToMinutes = (time) => {
        if (!time) return 0;
        const [h, m] = time.split(":").map(Number);
        return h * 60 + m;
      };

      const mockAttendanceData = [
        // Days 1-5: Over 8 hours (Green)
        { type: "Present", checkIn: "09:00", checkOut: "17:30" }, // 8.5h
        { type: "Present", checkIn: "08:30", checkOut: "17:30" }, // 9.0h
        { type: "Present", checkIn: "09:00", checkOut: "18:00" }, // 9.0h
        { type: "Present", checkIn: "09:00", checkOut: "17:45" }, // 8.75h
        { type: "Present", checkIn: "09:15", checkOut: "17:45" }, // 8.5h

        // Days 6-10: Under 8 hours (Yellow)
        { type: "Present", checkIn: "09:00", checkOut: "16:30" }, // 7.5h
        { type: "Present", checkIn: "10:00", checkOut: "17:00" }, // 7.0h
        { type: "Present", checkIn: "09:00", checkOut: "16:00" }, // 7.0h
        { type: "Present", checkIn: "08:30", checkOut: "16:00" }, // 7.5h
        { type: "Present", checkIn: "09:00", checkOut: "16:45" }, // 7.75h

        // Days 11-15: Absent (Red)
        { type: "Absent", checkIn: null, checkOut: null },
        { type: "Absent", checkIn: null, checkOut: null },
        { type: "Present", checkIn: "09:00", checkOut: "18:00" }, // Normal Day
        { type: "Absent", checkIn: null, checkOut: null },
        { type: "Absent", checkIn: null, checkOut: null },

        // Days 16-20: Leave/Rest Day (Blue)
        { type: "Leave", checkIn: null, checkOut: null },
        { type: "Rest Day", checkIn: null, checkOut: null },
        { type: "Present", checkIn: "09:00", checkOut: "17:00" }, // Normal Day
        { type: "Leave", checkIn: null, checkOut: null },
        { type: "Rest Day", checkIn: null, checkOut: null },

        // Days 21-30: Mix of all statuses
        { type: "Present", checkIn: "09:00", checkOut: "18:00" }, // 9.0h (Green)
        { type: "Present", checkIn: "09:00", checkOut: "16:30" }, // 7.5h (Yellow)
        { type: "Absent", checkIn: null, checkOut: null }, // (Red)
        { type: "Leave", checkIn: null, checkOut: null }, // (Blue)
        { type: "Present", checkIn: "08:30", checkOut: "17:30" }, // 9.0h (Green)
        { type: "Rest Day", checkIn: null, checkOut: null }, // (Blue)
        { type: "Present", checkIn: "09:00", checkOut: "17:45" }, // 8.75h (Green)
        { type: "Present", checkIn: "09:30", checkOut: "16:30" }, // 7.0h (Yellow)
        { type: "Absent", checkIn: null, checkOut: null }, // (Red)
        { type: "Present", checkIn: "09:00", checkOut: "17:00" }, // 8.0h (Green)
      ];

      const generateChartData = (data) => {
        const chartLabels = [];
        const chartData = [];
        const chartColors = [];
        const targetMinutes = 8 * 60; // 480 minutes

        data.slice(0, 30).forEach((day, index) => {
          const dayNumber = (index + 1).toString().padStart(2, "0");
          chartLabels.push(dayNumber);

          if (day.type === "Present") {
            const checkInMins = timeToMinutes(day.checkIn);
            const checkOutMins = timeToMinutes(day.checkOut);

            // Calculate duration, ensuring checkOut is >= checkIn, otherwise duration is 0
            const durationMins = Math.max(0, checkOutMins - checkInMins);
            const durationHours = durationMins / 60;

            // Ratio of actual hours to target hours (8 hours)
            const dataRatio = durationHours / 8.0;

            // We push the ratio, which could be 0 if check-in/out were null/invalid
            chartData.push(dataRatio);

            if (durationHours >= 8.0) {
              // Green: Target met or exceeded
              chartColors.push("#2aa54f");
            } else if (durationHours > 0) {
              // Yellow: Present, but hours are short
              chartColors.push("#ffc107");
            } else {
              // Red: Duration is 0 or less (Invalid times recorded, treated as absent/no time)
              chartColors.push("#d83b13");
              // Note: If durationHours is 0 here, dataRatio is also 0, and the minBarLength fix handles visibility.
            }
          } else if (day.type === "Absent") {
            // Red: Explicitly Absent
            chartData.push(1);
            chartColors.push("#d83b13");
          } else {
            // Blue: Leave/Rest Day
            chartData.push(1.2);
            chartColors.push("#007bff");
          }
        });

        return { labels: chartLabels, data: chartData, colors: chartColors };
      };

      const initAttendanceChart = () => {
        const ctx = document.getElementById("attendanceChart").getContext("2d");
        const { labels, data, colors } = generateChartData(mockAttendanceData);

        new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Attendance Performance (Ratio to 8h Target)",
                data: data,
                backgroundColor: colors,
                borderRadius: 6,
                barPercentage: 0.9,
                categoryPercentage: 0.8,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                max: 1.3, // Adjusted max for the blue bar to fit
                ticks: {
                  stepSize: 0.25,
                  callback: (value) => {
                    if (value === 1.2) return "Leave/Rest Day";
                    if (value >= 1.0) return "> 8 Hours";
                    if (value >= 0.75) return "7-8 Hours";
                    if (value > 0) return "< 7 Hours";
                    if (value === 0) return "Absent";
                    return "";
                  },
                },
                title: {
                  display: true,
                  text: "Attendance Status / Ratio",
                },
              },
              x: {
                grid: { display: false },
                title: {
                  display: true,
                  text: "Day of the Month",
                },
              },
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    let label = context.dataset.label || "";
                    if (label) {
                      label += ": ";
                    }
                    const value = context.parsed.y;

                    if (value === 1.2) return "Status: Leave or Rest Day";
                    if (value === 0) return "Status: Absent";

                    const hoursWorked = value * 8; // Revert ratio back to hours
                    const status =
                      hoursWorked >= 8 ? "Great (>8h)" : "Low (<8h)";
                    return `Hours Worked: ${hoursWorked.toFixed(
                      2
                    )}h (${status})`;
                  },
                },
              },
            },
          },
        });
      };
    </script>
  </body>
</html>
